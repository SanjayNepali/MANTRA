{% extends 'base.html' %}

{% block title %}Generate Report - MANTRA{% endblock %}

{% block content %}
<div class="report-container">
    <div class="page-header">
        <h1><i class='bx bx-bar-chart-alt-2'></i> Generate Reports</h1>
        <a href="{% if is_subadmin %}{% url 'subadmin_dashboard' %}{% else %}{% url 'admin_dashboard' %}{% endif %}" class="btn btn-secondary">
            <i class='bx bx-arrow-back'></i> Back to Dashboard
        </a>
    </div>

    <!-- Report Type Selection -->
    <div class="report-selector">
        <h3>Select Report Type</h3>
        <div class="report-types-grid">
            <a href="?type=users{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
               class="report-type-card {% if report_type == 'users' %}active{% endif %}{% if is_subadmin and 'user_verification' not in assigned_areas %}disabled{% endif %}">
                <i class='bx bx-user'></i>
                <h4>Users Report</h4>
                <p>User statistics and demographics</p>
            </a>

            <a href="?type=content{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
               class="report-type-card {% if report_type == 'content' %}active{% endif %}{% if is_subadmin and 'content_moderation' not in assigned_areas %}disabled{% endif %}">
                <i class='bx bx-file'></i>
                <h4>Content Report</h4>
                <p>Posts and content analytics</p>
            </a>

            <a href="?type=moderation{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
               class="report-type-card {% if report_type == 'moderation' %}active{% endif %}{% if is_subadmin and 'content_moderation' not in assigned_areas %}disabled{% endif %}">
                <i class='bx bx-shield'></i>
                <h4>Moderation Report</h4>
                <p>Flagged content and reports</p>
            </a>

            <a href="?type=engagement{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
               class="report-type-card {% if report_type == 'engagement' %}active{% endif %}">
                <i class='bx bx-like'></i>
                <h4>Engagement Report</h4>
                <p>Likes, comments, shares analysis</p>
            </a>

            {% if not is_subadmin %}
            <a href="?type=revenue{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
               class="report-type-card {% if report_type == 'revenue' %}active{% endif %}">
                <i class='bx bx-dollar-circle'></i>
                <h4>Revenue Report</h4>
                <p>Payment transactions analysis</p>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="filters-card">
        <h3>Date Range</h3>
        <form method="get" class="date-filter-form">
            <input type="hidden" name="type" value="{{ report_type }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="date_from">From:</label>
                    <input type="date" name="date_from" id="date_from" value="{{ date_from }}" class="form-control">
                </div>
                <div class="form-group">
                    <label for="date_to">To:</label>
                    <input type="date" name="date_to" id="date_to" value="{{ date_to }}" class="form-control">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                        <i class='bx bx-filter'></i> Apply Filter
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Report Content -->
    <div class="report-content">
        {% if report_type == 'users' %}
            <div class="report-header">
                <h2>Users Report</h2>
                <a href="{% url 'export_report' %}?type=users&format=csv" class="btn btn-export">
                    <i class='bx bx-download'></i> Export CSV
                </a>
            </div>

            <div class="stats-overview">
                <div class="stat-box">
                    <h3>{{ total_users }}</h3>
                    <p>Total Users</p>
                </div>
                {% for ut in user_types %}
                <div class="stat-box">
                    <h3>{{ ut.count }}</h3>
                    <p>{{ ut.user_type|title }}s</p>
                </div>
                {% endfor %}
            </div>

            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>User Type</th>
                            <th>Posts</th>
                            <th>Followers</th>
                            <th>Joined</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td><span class="badge">{{ user.user_type }}</span></td>
                            <td>{{ user.posts_count }}</td>
                            <td>{{ user.followers_count }}</td>
                            <td>{{ user.date_joined|date:"M d, Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% elif report_type == 'content' %}
            <div class="report-header">
                <h2>Content Report</h2>
                <a href="{% url 'export_report' %}?type=content&format=csv" class="btn btn-export">
                    <i class='bx bx-download'></i> Export CSV
                </a>
            </div>

            <div class="stats-overview">
                <div class="stat-box">
                    <h3>{{ total_posts }}</h3>
                    <p>Total Posts</p>
                </div>
                <div class="stat-box">
                    <h3>{{ avg_engagement.avg_likes|floatformat:1 }}</h3>
                    <p>Avg Likes</p>
                </div>
                <div class="stat-box">
                    <h3>{{ avg_engagement.avg_comments|floatformat:1 }}</h3>
                    <p>Avg Comments</p>
                </div>
                <div class="stat-box">
                    <h3>{{ avg_engagement.avg_shares|floatformat:1 }}</h3>
                    <p>Avg Shares</p>
                </div>
            </div>

            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Author</th>
                            <th>Content</th>
                            <th>Likes</th>
                            <th>Comments</th>
                            <th>Shares</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for post in posts %}
                        <tr>
                            <td>{{ post.author.username }}</td>
                            <td>{{ post.content|truncatewords:15 }}</td>
                            <td>{{ post.likes_count }}</td>
                            <td>{{ post.comments_count }}</td>
                            <td>{{ post.shares_count }}</td>
                            <td>{{ post.created_at|date:"M d, Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% elif report_type == 'moderation' %}
            <div class="report-header">
                <h2>Moderation Report</h2>
                <a href="{% url 'export_report' %}?type=moderation&format=csv" class="btn btn-export">
                    <i class='bx bx-download'></i> Export CSV
                </a>
            </div>

            <div class="stats-overview">
                <div class="stat-box">
                    <h3>{{ total_reports }}</h3>
                    <p>Total Reports</p>
                </div>
                <div class="stat-box alert-stat">
                    <h3>{{ pending_reports }}</h3>
                    <p>Pending Review</p>
                </div>
            </div>

            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Post ID</th>
                            <th>Reported By</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                        <tr>
                            <td>{{ report.post.id|truncatechars:12 }}</td>
                            <td>{{ report.reported_by.username }}</td>
                            <td>{{ report.reason }}</td>
                            <td>
                                {% if report.is_reviewed %}
                                    <span class="status-badge reviewed">Reviewed</span>
                                {% else %}
                                    <span class="status-badge pending">Pending</span>
                                {% endif %}
                            </td>
                            <td>{{ report.created_at|date:"M d, Y H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% elif report_type == 'engagement' %}
            <div class="report-header">
                <h2>Engagement Report</h2>
            </div>

            <div class="stats-overview">
                <div class="stat-box">
                    <h3>{{ engagement_stats.total_likes|default:0 }}</h3>
                    <p>Total Likes</p>
                </div>
                <div class="stat-box">
                    <h3>{{ engagement_stats.total_comments|default:0 }}</h3>
                    <p>Total Comments</p>
                </div>
                <div class="stat-box">
                    <h3>{{ engagement_stats.total_shares|default:0 }}</h3>
                    <p>Total Shares</p>
                </div>
                <div class="stat-box">
                    <h3>{{ engagement_stats.total_views|default:0 }}</h3>
                    <p>Total Views</p>
                </div>
            </div>

            <h3>Top 10 Posts</h3>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Author</th>
                            <th>Content</th>
                            <th>Likes</th>
                            <th>Comments</th>
                            <th>Shares</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for post in top_posts %}
                        <tr>
                            <td>{{ post.author.username }}</td>
                            <td>{{ post.content|truncatewords:10 }}</td>
                            <td>{{ post.likes_count }}</td>
                            <td>{{ post.comments_count }}</td>
                            <td>{{ post.shares_count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% elif report_type == 'revenue' %}
            <div class="report-header">
                <h2>Revenue Report</h2>
                <a href="{% url 'export_report' %}?type=revenue&format=csv" class="btn btn-export">
                    <i class='bx bx-download'></i> Export CSV
                </a>
            </div>

            <div class="stats-overview">
                <div class="stat-box revenue-stat">
                    <h3>NPR {{ total_revenue|floatformat:2 }}</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-box">
                    <h3>{{ total_transactions }}</h3>
                    <p>Total Transactions</p>
                </div>
                <div class="stat-box success-stat">
                    <h3>{{ successful_transactions }}</h3>
                    <p>Successful</p>
                </div>
            </div>

        {% else %}
            <div class="empty-state">
                <i class='bx bx-bar-chart-alt-2'></i>
                <p>Select a report type to view analytics</p>
            </div>
        {% endif %}
    </div>
</div>

<style>
:root {
    --pink: #FFB6C1;
    --pink-light: #FFE4E9;
    --sage-green: #87A96B;
    --sage-light: #c5d5b0;
    --brown: #964B00;
    --border: #e0e0e0;
}

.report-container {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 2rem;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.page-header h1 {
    font-size: 2rem;
    color: var(--brown);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.report-selector {
    background: white;
    border-radius: 10px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.report-selector h3 {
    color: var(--brown);
    margin-bottom: 1.5rem;
}

.report-types-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.report-type-card {
    padding: 1.5rem;
    border: 2px solid var(--border);
    border-radius: 10px;
    text-align: center;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
}

.report-type-card:hover {
    border-color: var(--pink);
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(255, 182, 193, 0.3);
}

.report-type-card.active {
    background: linear-gradient(135deg, var(--pink) 0%, var(--sage-green) 100%);
    color: white;
    border-color: transparent;
}

.report-type-card.disabled {
    opacity: 0.4;
    pointer-events: none;
}

.report-type-card i {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.report-type-card.active i {
    color: white;
}

.report-type-card:not(.active) i {
    color: var(--pink);
}

.report-type-card h4 {
    margin: 0.5rem 0;
    font-size: 1.1rem;
}

.report-type-card p {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.8;
}

.filters-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.filters-card h3 {
    color: var(--brown);
    margin-bottom: 1rem;
}

.date-filter-form .form-row {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
}

.form-group {
    flex: 1;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--brown);
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
}

.report-content {
    background: white;
    border-radius: 10px;
    padding: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-box {
    background: var(--pink-light);
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
}

.stat-box h3 {
    font-size: 2rem;
    color: var(--pink);
    margin: 0;
}

.stat-box p {
    margin: 0.5rem 0 0 0;
    color: var(--brown);
}

.stat-box.alert-stat {
    background: #fff3cd;
}

.stat-box.alert-stat h3 {
    color: #856404;
}

.stat-box.revenue-stat {
    background: var(--sage-light);
}

.stat-box.revenue-stat h3 {
    color: var(--sage-green);
}

.stat-box.success-stat {
    background: #d4edda;
}

.stat-box.success-stat h3 {
    color: #155724;
}

.data-table-container {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: var(--pink-light);
}

.data-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--brown);
}

.data-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
}

.badge {
    background: var(--sage-light);
    color: var(--sage-green);
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 500;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-badge.reviewed {
    background: #d4edda;
    color: #155724;
}

.status-badge.pending {
    background: #fff3cd;
    color: #856404;
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.btn-primary {
    background: var(--pink);
    color: white;
}

.btn-primary:hover {
    background: #ff9fb0;
}

.btn-secondary {
    background: var(--sage-green);
    color: white;
}

.btn-secondary:hover {
    background: #76985a;
}

.btn-export {
    background: var(--brown);
    color: white;
}

.btn-export:hover {
    background: #7a3c00;
}

.empty-state {
    text-align: center;
    padding: 4rem;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 5rem;
    opacity: 0.3;
    margin-bottom: 1rem;
}

@media (max-width: 768px) {
    .report-types-grid {
        grid-template-columns: 1fr;
    }

    .date-filter-form .form-row {
        flex-direction: column;
    }

    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
}
</style>
{% endblock %}
